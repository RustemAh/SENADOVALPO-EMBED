<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Resultados Regional ‚Äî Valpara√≠so 2025 (D‚ÄôHondt)</title>
<style>
:root { color-scheme: light; }
body { margin:0; font-family: Arial, Roboto, sans-serif; background:#fff; }
.wrap { max-width:720px; margin:0 auto; border:1px solid #ddd; border-radius:10px; overflow:hidden; }
.hd { padding:14px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; }
.hd h2 { margin:0; font-size:19px; font-weight:700; }
.ts { font-size:12px; color:#6b7280; margin-top:4px; }
.banner { background:#FFD400; padding:10px 16px; font-weight:700; text-transform:uppercase; border-bottom:1px solid #eee; }

.controls { display:flex; gap:8px; align-items:center; padding:8px 16px; border-bottom:1px solid #eee; flex-wrap:wrap; }
.btn { background:#005CA9; color:#fff; border:none; border-radius:6px; padding:6px 12px; font-size:13px; font-weight:600; cursor:pointer; }
.btn:hover { background:#004B8A; }
.btn-secondary { background:#374151; }
.btn-secondary:hover { background:#1f2937; }

.note { padding:10px 16px; color:#6b7280; font-size:12px; border-top:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; }
.total { background:#fafafa; font-weight:700; }
.winner { background:#F3F8FF; }
.chip-electo { display:inline-flex; align-items:center; gap:4px; background:#FFD400; color:#000; border-radius:6px; padding:2px 6px; font-size:11px; font-weight:700; margin-left:6px; }

.row { border-top:1px solid #eee; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
.name-side { flex:1 1 60%; display:flex; align-items:center; gap:8px; }
.stats-side { flex:1 1 40%; text-align:right; font-size:13px; color:#333; }

.photo { width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid #ddd; flex-shrink:0; }
.party-badge { display:inline-block; min-width:28px; text-align:center; color:#fff; border-radius:4px; padding:3px 7px; font-weight:700; background:#6b7280; font-size:13px; }
.bar-group { display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:4px; }
.bar-rail { width:100%; max-width:120px; height:8px; background:#e5e7eb; border-radius:6px; overflow:hidden; }
.bar-fill { height:8px; border-radius:6px; }

.list-header { background:#f3f4f6; color:#374151; font-weight:700; }
.list-header .stats-side { color:#9ca3af; }

.seats-wrap { padding:10px 16px; border-top:1px solid #eee; font-size:13px; color:#333; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.seat-pill { display:inline-flex; align-items:center; gap:6px; border:1px solid #ddd; border-radius:999px; padding:4px 10px; }
.seat-dot { width:10px; height:10px; border-radius:50%; background:#6b7280; display:inline-block; }
.seat-count { font-weight:700; }

@media (max-width:480px) {
  .photo { width:30px; height:30px; }
  .hd h2 { font-size:17px; }
  .party-badge { padding:2px 6px; font-size:12px; }
  .bar-group { flex-direction:row-reverse; gap:6px; justify-content:flex-end; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="hd">
    <div>
      <h2>Elecci√≥n Regional ‚Äî Valpara√≠so 2025</h2>
      <div class="ts" id="ts">‚Äî</div>
    </div>
  </div>

  <div id="banner" class="banner">ASIGNACI√ìN DE 5 ESCA√ëOS ‚Äî M√âTODO D‚ÄôHONDT</div>

  <div class="controls">
    <button id="toggleBtn" class="btn btn-secondary" title="Ver solo los posibles electos">üë• Ver posibles electos</button>
    <button id="refreshBtn" class="btn" title="Actualizar ahora">üîÑ Actualizar</button>
    <span id="hint" style="font-size:12px; color:#6b7280;">Electos ordenados por mayor votaci√≥n individual</span>
  </div>

  <div id="rows"></div>

  <div class="row total">
    <div style="font-weight:600;color:#6b7280;">Total votos v√°lidos</div>
    <div id="totalVotes" style="font-weight:600;">‚Äî</div>
  </div>

  <div id="seats" class="seats-wrap" aria-live="polite"></div>

  <div class="note">
    <div id="footnote">Actualiza cada 60 s ¬∑ Fuente: Google Sheets</div>
    <div id="tsBottom"></div>
  </div>
</div>

<script>
const DATA_URL="https://docs.google.com/spreadsheets/d/1lFbOXepc2zPXOUIOhTRnP4q9Ry_oye_9zHJ1HX_9Njc/export?format=csv";
const REFRESH_MS=60000;

let showElectedOnly = false; // estado del toggle

/* Colores por pacto/candidato (agrega pactos para colores propios si quieres) */
const candidateColorMap={ "Voto nulo / blanco":"#999999" };
function setPartyColor(party, color){ if (party && color) candidateColorMap[party]=color; }
function colorForRow(r){ return candidateColorMap[r.candidate]||candidateColorMap[r.party]||"#6b7280"; }
function formatInt(n){ return (n||0).toLocaleString("es-CL"); }
function nowStamp(){ const d=new Date(); return d.toLocaleString("es-CL",{dateStyle:"medium",timeStyle:"short"}); }

/* Parseo robusto de votos */
function parseVotes(x){
  if (x==null) return 0;
  const s=String(x).trim(); if (!s) return 0;
  const onlyDigits=s.replace(/[^\d]/g,"");
  return onlyDigits? Number(onlyDigits) : 0;
}

/* CSV simple */
function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  const headers=lines.shift().split(",").map(h=>h.trim());
  return lines.filter(l=>l.trim().length>0).map(line=>{
    const cols=line.split(",").map(c=>c.trim());
    const obj={};
    headers.forEach((h,i)=>obj[h]=cols[i]||"");
    obj.votes=parseVotes(obj.votes);
    obj.percent=obj.percent?Number(String(obj.percent).replace(",", ".")):0;
    return obj;
  });
}

/* Detectores */
function isNullBlanco(r){ return (r.candidate||"").toLowerCase().includes("voto nulo"); }
function isListHeader(r){
  const name=(r.candidate||"").toLowerCase();
  const party=(r.party||"").toLowerCase();
  return name.includes("lista") || party.includes("lista");
}

/* D‚ÄôHondt exacto: V/1..V/SEATS con votos sumados por lista */
function dhondtAllocate(rows, SEATS){
  // Sumar votos por lista (party) usando solo candidatos reales
  const partyVotes = {};
  rows.forEach(r=>{
    if (!isNullBlanco(r) && !isListHeader(r) && r.party){
      partyVotes[r.party] = (partyVotes[r.party]||0) + (r.votes||0);
    }
  });

  const parties = Object.keys(partyVotes);
  const totalVotesAll = parties.reduce((a,p)=>a+partyVotes[p],0);
  if (totalVotesAll===0) return {partySeats:{}, seatWinners:[]};

  // Cocientes
  const quotients = [];
  parties.forEach(p=>{
    const V = partyVotes[p];
    for (let k=1; k<=SEATS; k++){
      quotients.push({ party:p, k, q: V / k, baseVotes: V });
    }
  });

  // Orden estricta por q desc; desempate: mayor V base, luego nombre party
  quotients.sort((a,b)=> b.q - a.q || b.baseVotes - a.baseVotes || (a.party>b.party?1:-1));
  const top = quotients.slice(0, SEATS);

  // Esca√±os por party
  const partySeats = {};
  top.forEach(x=>{ partySeats[x.party] = (partySeats[x.party]||0) + 1; });

  // Ganadores: dentro de cada party, los n m√°s votados (n = esca√±os asignados)
  const seatWinners = [];
  Object.keys(partySeats).forEach(p=>{
    const n = partySeats[p];
    const inParty = rows.filter(r=> r.party===p && !isNullBlanco(r) && !isListHeader(r));
    inParty.sort((a,b)=>(b.votes||0)-(a.votes||0) || (b.percent||0)-(a.percent||0));
    inParty.slice(0, n).forEach(r=> seatWinners.push(r.candidate));
  });

  return { partySeats, seatWinners, partyVotes, quotients, top };
}

/* Render general con soporte para modo "electos" */
function render(rows){
  const blanco = rows.find(isNullBlanco);
  const candidates = rows.filter(r=>!isNullBlanco(r) && !isListHeader(r));
  const allZero = candidates.length>0 && candidates.every(r=>(+r.votes||0)===0 && (+r.percent||0)===0);

  // D‚ÄôHondt: 5 esca√±os
  const SEATS = 5;
  const { partySeats, seatWinners } = dhondtAllocate(rows, SEATS);

  const rowsDiv=document.getElementById("rows");
  rowsDiv.innerHTML="";
  let total=0;

  // Banner visible solo si hay votos
  document.getElementById("banner").style.display = allZero ? "none" : "block";

  if (showElectedOnly){
    // Vista SOLO electos, ordenados por mayor votaci√≥n individual
    const electedRows = candidates
      .filter(r=> seatWinners.includes(r.candidate))
      .sort((a,b)=>(b.votes||0)-(a.votes||0) || (b.percent||0)-(a.percent||0));

    electedRows.forEach(r=>{
      total += (r.votes||0);
      const color = colorForRow(r);
      const pct = Math.max(0, Math.min(100, Number(r.percent)||0));
      const photo = r.photo ? `<img src="${r.photo}" alt="${r.candidate}" class="photo"/>` : "";
      rowsDiv.innerHTML += `
        <div class="row winner">
          <div class="name-side">
            ${photo}
            <div>
              <div style="font-weight:700;">
                ${r.candidate||""}
                ${!allZero?`<span class="chip-electo">‚úì Electo (D‚ÄôHondt)</span>`:""}
              </div>
              <div><span class="party-badge" style="background:${color};">${r.party||"‚Äî"}</span></div>
            </div>
          </div>
          <div class="stats-side">
            ${r.votes?formatInt(r.votes):"‚Äî"}
            <div class="bar-group">
              <div class="bar-rail"><div class="bar-fill" style="width:${pct}%;background:${color};"></div></div>
              <div style="font-weight:600;min-width:40px;">${pct>0?pct.toFixed(1)+"%":"‚Äî"}</div>
            </div>
          </div>
        </div>`;
    });

    // En modo electos NO mostramos ‚ÄúVoto nulo / blanco‚Äù ni encabezados de Lista
  } else {
    // Vista completa: respetar ORDEN de la hoja (muestra headers "Lista ...")
    rows.forEach(r=>{
      if (isNullBlanco(r)) return; // lo pintamos despu√©s
      if (isListHeader(r)) {
        rowsDiv.innerHTML += `
          <div class="row list-header">
            <div class="name-side">${r.candidate||r.party||"Lista"}</div>
            <div class="stats-side">${r.party? r.party : ""}</div>
          </div>`;
        return;
      }
      const color = colorForRow(r);
      const pct = Math.max(0, Math.min(100, Number(r.percent)||0));
      const isElected = !allZero && seatWinners.includes(r.candidate);
      total += (r.votes||0);
      const photo = r.photo ? `<img src="${r.photo}" alt="${r.candidate}" class="photo"/>` : "";
      rowsDiv.innerHTML += `
        <div class="row${isElected?" winner":""}">
          <div class="name-side">
            ${photo}
            <div>
              <div style="font-weight:${isElected?"700":"500"};">
                ${r.candidate||""}
                ${isElected?`<span class="chip-electo">‚úì Electo (D‚ÄôHondt)</span>`:""}
              </div>
              <div><span class="party-badge" style="background:${color};">${r.party||"‚Äî"}</span></div>
            </div>
          </div>
          <div class="stats-side">
            ${r.votes?formatInt(r.votes):"‚Äî"}
            <div class="bar-group">
              <div class="bar-rail"><div class="bar-fill" style="width:${pct}%;background:${color};"></div></div>
              <div style="font-weight:600;min-width:40px;">${pct>0?pct.toFixed(1)+"%":"‚Äî"}</div>
            </div>
          </div>
        </div>`;
    });

    // ‚ÄúVoto nulo / blanco‚Äù SIEMPRE antes del total (no participa de D‚ÄôHondt)
    if (blanco){
      const color = colorForRow(blanco);
      const pct = Math.max(0, Math.min(100, Number(blanco.percent)||0));
      rowsDiv.innerHTML += `
        <div class="row">
          <div class="name-side">
            <div style="font-weight:500;">${blanco.candidate}</div>
            <div><span class="party-badge" style="background:${color};">${blanco.party||"‚Äî"}</span></div>
          </div>
          <div class="stats-side">
            ${blanco.votes?formatInt(blanco.votes):"‚Äî"}
            <div class="bar-group">
              <div class="bar-rail"><div class="bar-fill" style="width:${pct}%;background:${color};"></div></div>
              <div style="font-weight:600;min-width:40px;">${pct>0?pct.toFixed(1)+"%":"‚Äî"}</div>
            </div>
          </div>
        </div>`;
    }
  }

  // Totales y timestamps
  document.getElementById("totalVotes").textContent = total?formatInt(total):"‚Äî";
  const stamp = "Actualizado: " + nowStamp();
  document.getElementById("ts").textContent = stamp;
  document.getElementById("tsBottom").textContent = stamp;

  // Resumen de esca√±os por LISTA
  const seatsDiv=document.getElementById("seats");
  seatsDiv.innerHTML="";
  if (Object.keys(partySeats).length===0){
    seatsDiv.textContent = "Sin asignaci√≥n de esca√±os (no hay votos).";
  }else{
    seatsDiv.innerHTML = `<div style="font-weight:700;">D‚ÄôHondt (5 esca√±os):</div>`;
    Object.keys(partySeats).sort((a,b)=> (partySeats[b]||0)-(partySeats[a]||0) || (a>b?1:-1))
      .forEach(p=>{
        const c = candidateColorMap[p] || "#6b7280";
        seatsDiv.innerHTML += `
          <span class="seat-pill">
            <span class="seat-dot" style="background:${c};"></span>
            <span><b>${p}</b></span>
            <span class="seat-count">${partySeats[p]}</span>
          </span>`;
      });
  }
}

/* Carga y refresco */
async function fetchCSV(url){
  const res=await fetch(url+(url.includes("?")?"&":"?")+"t="+Date.now(),{cache:"no-store"});
  if(!res.ok) throw new Error("No se pudo cargar CSV");
  return await res.text();
}
async function load(){
  try{
    const text=await fetchCSV(DATA_URL);
    const rows=parseCSV(text);

    // (Opcional) Colores fijos por pacto:
    // setPartyColor("Pacto A", "#005CA9");
    // setPartyColor("Pacto B", "#E5252A");
    // setPartyColor("Pacto C", "#27AE60");

    render(rows);
    document.getElementById("footnote").textContent="Actualiza cada "+(REFRESH_MS/1000)+" s ¬∑ Fuente: Google Sheets (CSV)";
  }catch(e){
    console.error(e);
    document.getElementById("footnote").textContent="Error cargando CSV (revisa permisos o gid de la hoja).";
  }
}

/* Botones */
document.getElementById("refreshBtn").addEventListener("click",()=>{
  const btn=document.getElementById("refreshBtn");
  const tb=document.getElementById("toggleBtn");
  btn.textContent="‚è≥ Actualizando...";
  btn.disabled=true; tb.disabled=true;
  load().then(()=>{
    btn.textContent="üîÑ Actualizar";
    btn.disabled=false; tb.disabled=false;
  });
});

document.getElementById("toggleBtn").addEventListener("click",()=>{
  showElectedOnly = !showElectedOnly;
  const tb=document.getElementById("toggleBtn");
  tb.textContent = showElectedOnly ? "üîô Volver a ver todas las listas" : "üë• Ver posibles electos";
  // Re-render con el estado actual y datos ya cargados
  // Para evitar refetch innecesario, obtenemos el DOM actual y lo reusamos:
  fetchCSV(DATA_URL).then(parseCSV).then(rows=>render(rows)).catch(()=>{});
});

load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>

