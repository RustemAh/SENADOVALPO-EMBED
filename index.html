<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Resultados Regional â€” ValparaÃ­so 2025 (Dâ€™Hondt por Lista)</title>
<style>
:root { color-scheme: light; }
body { margin:0; font-family: Arial, Roboto, sans-serif; background:#fff; }
.wrap { max-width:720px; margin:0 auto; border:1px solid #ddd; border-radius:10px; overflow:hidden; }
.hd { padding:14px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; }
.hd h2 { margin:0; font-size:19px; font-weight:700; }
.ts { font-size:12px; color:#6b7280; margin-top:4px; }
.banner { background:#FFD400; padding:10px 16px; font-weight:700; text-transform:uppercase; border-bottom:1px solid #eee; }

.controls { display:flex; gap:8px; align-items:center; padding:8px 16px; border-bottom:1px solid #eee; flex-wrap:wrap; }
.btn { background:#005CA9; color:#fff; border:none; border-radius:6px; padding:6px 12px; font-size:13px; font-weight:600; cursor:pointer; }
.btn:hover { background:#004B8A; }
.btn-secondary { background:#374151; }
.btn-secondary:hover { background:#1f2937; }

.note { padding:10px 16px; color:#6b7280; font-size:12px; border-top:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; }
.total { background:#fafafa; font-weight:700; }
.winner { background:#F3F8FF; }
.chip-electo { display:inline-flex; align-items:center; gap:4px; background:#FFD400; color:#000; border-radius:6px; padding:2px 6px; font-size:11px; font-weight:700; margin-left:6px; }

.row { border-top:1px solid #eee; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
.name-side { flex:1 1 60%; display:flex; align-items:center; gap:8px; }
.stats-side { flex:1 1 40%; text-align:right; font-size:13px; color:#333; }

.photo { width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid #ddd; flex-shrink:0; }
.party-badge { display:inline-block; min-width:28px; text-align:center; color:#fff; border-radius:4px; padding:3px 7px; font-weight:700; background:#6b7280; font-size:13px; }
.bar-group { display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:4px; }
.bar-rail { width:100%; max-width:120px; height:8px; background:#e5e7eb; border-radius:6px; overflow:hidden; }
.bar-fill { height:8px; border-radius:6px; }

.list-header { background:#f3f4f6; color:#374151; font-weight:700; }
.list-header .stats-side { color:#9ca3af; }

.seats-wrap { padding:10px 16px; border-top:1px solid #eee; font-size:13px; color:#333; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.seat-pill { display:inline-flex; align-items:center; gap:6px; border:1px solid #ddd; border-radius:999px; padding:4px 10px; }
.seat-dot { width:10px; height:10px; border-radius:50%; background:#6b7280; display:inline-block; }
.seat-count { font-weight:700; }

@media (max-width:480px) {
  .photo { width:30px; height:30px; }
  .hd h2 { font-size:17px; }
  .party-badge { padding:2px 6px; font-size:12px; }
  .bar-group { flex-direction:row-reverse; gap:6px; justify-content:flex-end; }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="hd">
    <div>
      <h2>ElecciÃ³n Regional â€” ValparaÃ­so 2025</h2>
      <div class="ts" id="ts">â€”</div>
    </div>
  </div>

  <div id="banner" class="banner">ASIGNACIÃ“N DE 5 ESCAÃ‘OS â€” MÃ‰TODO Dâ€™HONDT (por Lista)</div>

  <div class="controls">
    <button id="toggleBtn" class="btn btn-secondary" title="Ver solo los posibles electos">ðŸ‘¥ Ver posibles electos</button>
    <button id="refreshBtn" class="btn" title="Actualizar ahora">ðŸ”„ Actualizar</button>
    <span id="hint" style="font-size:12px; color:#6b7280;">Electos ordenados por mayor votaciÃ³n individual</span>
  </div>

  <div id="rows"></div>

  <div class="row total">
    <div style="font-weight:600;color:#6b7280;">Total votos vÃ¡lidos</div>
    <div id="totalVotes" style="font-weight:600;">â€”</div>
  </div>

  <div id="seats" class="seats-wrap" aria-live="polite"></div>

  <div class="note">
    <div id="footnote">Actualiza cada 60 s Â· Fuente: Google Sheets</div>
    <div id="tsBottom"></div>
  </div>
</div>

<script>
const DATA_URL="https://docs.google.com/spreadsheets/d/1lFbOXepc2zPXOUIOhTRnP4q9Ry_oye_9zHJ1HX_9Njc/export?format=csv";
const REFRESH_MS=60000;

let showElectedOnly=false;

/* Colores por lista/candidato (opcional) */
const colorMap={ "Voto nulo / blanco":"#999999" };
function setColor(key, color){ if (key) colorMap[key]=color; }
function colorForRow(r){ return colorMap[candidateField(r)] || colorMap[listKey(r)] || colorMap[partyField(r)] || "#6b7280"; }
function formatInt(n){ return (n||0).toLocaleString("es-CL"); }
function nowStamp(){ const d=new Date(); return d.toLocaleString("es-CL",{dateStyle:"medium",timeStyle:"short"}); }

/* CSV simple */
function parseVotes(x){
  if (x==null) return 0;
  const s=String(x).trim(); if (!s) return 0;
  const onlyDigits=s.replace(/[^\d]/g,"");
  return onlyDigits? Number(onlyDigits) : 0;
}
function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  const headers=lines.shift().split(",").map(h=>h.trim().toLowerCase());
  return lines.filter(l=>l.trim().length>0).map(line=>{
    const cols=line.split(",").map(c=>c.trim());
    const obj={};
    headers.forEach((h,i)=>obj[h]=cols[i]||"");
    obj.votes=obj.votes?parseVotes(obj.votes):0;
    obj.percent=obj.percent?Number(String(obj.percent).replace(",", ".")):0;
    return obj;
  });
}

/* Helpers para campos variables */
function getField(r, names){
  for (const n of names){ if (r[n]!=null && String(r[n]).trim()!=="") return String(r[n]).trim(); }
  return "";
}
function candidateField(r){ return getField(r,["candidate","candidato","nombre"]); }
function partyField(r){ return getField(r,["party","partido"]); }
function listaField(r){ return getField(r,["lista","pacto","coalition","bloque","alianza","list","bloc"]); }

/* Detectores */
function isNullBlanco(r){
  return (candidateField(r)||"").toLowerCase().includes("voto nulo");
}
function isListHeader(r){
  const name=(candidateField(r)||"").toLowerCase();
  const party=(partyField(r)||"").toLowerCase();
  const lista=(listaField(r)||"").toLowerCase();
  return name.startsWith("lista ") || name.includes(" lista ") || party.startsWith("lista ") || lista.startsWith("lista ");
}

/* Extraer cÃ³digo de lista (B/C/I/J/K) si viene como 'C. Unidad por Chile' */
function extractListCodeFromText(s){
  const m = String(s||"").trim().match(/^([A-ZÃÃ‰ÃÃ“ÃšÃ‘])\./);
  return m? m[1].toUpperCase() : "";
}
function listKey(r){
  const lista = listaField(r);
  const code = extractListCodeFromText(lista);
  if (code) return code;          // "C"
  if (lista) return lista;        // nombre completo de la lista
  const party = partyField(r);
  const codeFromParty = extractListCodeFromText(party);
  if (codeFromParty) return codeFromParty;
  return party || "";
}

/* Dâ€™Hondt exacto por LISTA: V/1..V/SEATS con votos sumados por 'lista' */
function dhondtAllocate(rows, SEATS){
  const valid = rows.filter(r=> !isNullBlanco(r) && !isListHeader(r) && listKey(r));
  const byList = {};
  valid.forEach(r=>{
    const L=listKey(r);
    byList[L]=(byList[L]||0)+(r.votes||0);
  });

  const lists=Object.keys(byList);
  const totalVotesAll=lists.reduce((a,l)=>a+byList[l],0);
  if (totalVotesAll===0) return { listSeats:{}, seatWinners:[] };

  const quotients=[];
  lists.forEach(L=>{
    const V=byList[L];
    for(let k=1;k<=SEATS;k++){ quotients.push({list:L,k,q:V/k,baseVotes:V}); }
  });
  quotients.sort((a,b)=> b.q - a.q || b.baseVotes - a.baseVotes || (a.list>b.list?1:-1));
  const top=quotients.slice(0,SEATS);

  const listSeats={};
  top.forEach(x=>{ listSeats[x.list]=(listSeats[x.list]||0)+1; });

  const seatWinners=[];
  Object.keys(listSeats).forEach(L=>{
    const n=listSeats[L];
    const inList = valid.filter(r=> listKey(r)===L );
    inList.sort((a,b)=>(b.votes||0)-(a.votes||0) || (b.percent||0)-(a.percent||0));
    inList.slice(0,n).forEach(r=> seatWinners.push(candidateField(r)));
  });

  return { listSeats, seatWinners };
}

/* Render con toggle de electos */
function render(rows){
  const blanco=rows.find(isNullBlanco);
  const candidates=rows.filter(r=>!isNullBlanco(r) && !isListHeader(r));
  const allZero=candidates.length>0 && candidates.every(r=>(+r.votes||0)===0 && (+r.percent||0)===0);

  const SEATS=5;
  const { listSeats, seatWinners } = dhondtAllocate(rows, SEATS);

  const rowsDiv=document.getElementById("rows");
  rowsDiv.innerHTML="";
  let total=0;

  document.getElementById("banner").style.display = allZero ? "none" : "block";

  if (showElectedOnly){
    const electedRows=candidates
      .filter(r=> seatWinners.includes(candidateField(r)))
      .sort((a,b)=>(b.votes||0)-(a.votes||0) || (b.percent||0)-(a.percent||0));

    electedRows.forEach(r=>{
      total += (r.votes||0);
      const color=colorForRow(r);
      const pct=Math.max(0,Math.min(100,Number(r.percent)||0));
      const photo=r.photo?`<img src="${r.photo}" alt="${candidateField(r)}" class="photo"/>`:"";
      rowsDiv.innerHTML += `
        <div class="row winner">
          <div class="name-side">
            ${photo}
            <div>
              <div style="font-weight:700;">
                ${candidateField(r)}<span class="chip-electo">âœ“ Electo (Dâ€™Hondt)</span>
              </div>
              <div><span class="party-badge" style="background:${color};">${listKey(r) || listaField(r) || partyField(r) || "â€”"}</span></div>
            </div>
          </div>
          <div class="stats-side">
            ${r.votes?formatInt(r.votes):"â€”"}
            <div class="bar-group">
              <div class="bar-rail"><div class="bar-fill" style="width:${pct}%;background:${color};"></div></div>
              <div style="font-weight:600;min-width:40px;">${pct>0?pct.toFixed(1)+"%":"â€”"}</div>
            </div>
          </div>
        </div>`;
    });

  } else {
    rows.forEach(r=>{
      if (isNullBlanco(r)) return;

      if (isListHeader(r)) {
        rowsDiv.innerHTML += `
          <div class="row list-header">
            <div class="name-side">${candidateField(r) || listaField(r) || "Lista"}</div>
            <div class="stats-side">${listaField(r) || partyField(r) || ""}</div>
          </div>`;
        return;
      }

      const color=colorForRow(r);
      const pct=Math.max(0,Math.min(100,Number(r.percent)||0));
      const elected = !allZero && seatWinners.includes(candidateField(r));
      total += (r.votes||0);
      const photo=r.photo?`<img src="${r.photo}" alt="${candidateField(r)}" class="photo"/>`:"";
      rowsDiv.innerHTML += `
        <div class="row${elected?" winner":""}">
          <div class="name-side">
            ${photo}
            <div>
              <div style="font-weight:${elected?"700":"500"};">
                ${candidateField(r)}${elected?`<span class="chip-electo">âœ“ Electo (Dâ€™Hondt)</span>`:""}
              </div>
              <div><span class="party-badge" style="background:${color};">${listKey(r) || listaField(r) || partyField(r) || "â€”"}</span></div>
            </div>
          </div>
          <div class="stats-side">
            ${r.votes?formatInt(r.votes):"â€”"}
            <div class="bar-group">
              <div class="bar-rail"><div class="bar-fill" style="width:${pct}%;background:${color};"></div></div>
              <div style="font-weight:600;min-width:40px;">${pct>0?pct.toFixed(1)+"%":"â€”"}</div>
            </div>
          </div>
        </div>`;
    });

    if (blanco){
      const color=colorForRow(blanco);
      const pct=Math.max(0,Math.min(100,Number(blanco.percent)||0));
      rowsDiv.innerHTML += `
        <div class="row">
          <div class="name-side">
            <div style="font-weight:500;">${candidateField(blanco)||"Voto nulo / blanco"}</div>
            <div><span class="party-badge" style="background:${color};">${listKey(blanco) || partyField(blanco) || "â€”"}</span></div>
          </div>
          <div class="stats-side">
            ${blanco.votes?formatInt(blanco.votes):"â€”"}
            <div class="bar-group">
              <div class="bar-rail"><div class="bar-fill" style="width:${pct}%;background:${color};"></div></div>
              <div style="font-weight:600;min-width:40px;">${pct>0?pct.toFixed(1)+"%":"â€”"}</div>
            </div>
          </div>
        </div>`;
    }
  }

  document.getElementById("totalVotes").textContent = total?formatInt(total):"â€”";
  const stamp="Actualizado: "+nowStamp();
  document.getElementById("ts").textContent=stamp;
  document.getElementById("tsBottom").textContent=stamp;

  const seatsDiv=document.getElementById("seats");
  seatsDiv.innerHTML="";
  if (Object.keys(listSeats).length===0){
    seatsDiv.textContent="Sin asignaciÃ³n de escaÃ±os (no hay votos).";
  }else{
    seatsDiv.innerHTML=`<div style="font-weight:700;">Dâ€™Hondt (5 escaÃ±os):</div>`;
    Object.keys(listSeats).sort((a,b)=> (listSeats[b]||0)-(listSeats[a]||0) || (a>b?1:-1))
      .forEach(L=>{
        const c=colorMap[L]||"#6b7280";
        seatsDiv.innerHTML += `
          <span class="seat-pill">
            <span class="seat-dot" style="background:${c};"></span>
            <span><b>${L}</b></span>
            <span class="seat-count">${listSeats[L]}</span>
          </span>`;
      });
  }
}

/* Fetch & refresco */
async function fetchCSV(url){
  const res=await fetch(url+(url.includes("?")?"&":"?")+"t="+Date.now(),{cache:"no-store"});
  if(!res.ok) throw new Error("No se pudo cargar CSV");
  return await res.text();
}
async function load(){
  try{
    const text=await fetchCSV(DATA_URL);
    const rows=parseCSV(text);

    // (Opcional) Colores por lista:
    // setColor("C", "#005CA9"); setColor("J", "#E5252A"); setColor("K", "#27AE60");
    // setColor("I", "#8E44AD"); setColor("B", "#7F8C8D");

    render(rows);
    document.getElementById("footnote").textContent="Actualiza cada "+(REFRESH_MS/1000)+" s Â· Fuente: Google Sheets (CSV)";
  }catch(e){
    console.error(e);
    document.getElementById("footnote").textContent="Error cargando CSV (revisa permisos o gid de la hoja).";
  }
}

/* Botones */
document.getElementById("refreshBtn").addEventListener("click",()=>{
  const btn=document.getElementById("refreshBtn");
  const tb=document.getElementById("toggleBtn");
  btn.textContent="â³ Actualizando...";
  btn.disabled=true; tb.disabled=true;
  load().then(()=>{ btn.textContent="ðŸ”„ Actualizar"; btn.disabled=false; tb.disabled=false; });
});
document.getElementById("toggleBtn").addEventListener("click",()=>{
  showElectedOnly=!showElectedOnly;
  const tb=document.getElementById("toggleBtn");
  tb.textContent = showElectedOnly ? "ðŸ”™ Volver a ver todas las listas" : "ðŸ‘¥ Ver posibles electos";
  fetchCSV(DATA_URL).then(parseCSV).then(rows=>render(rows)).catch(()=>{});
});

load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>


