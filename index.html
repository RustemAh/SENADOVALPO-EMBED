<script>
const DATA_URL="https://docs.google.com/spreadsheets/d/1lFbOXepc2zPXOUIOhTRnP4q9Ry_oye_9zHJ1HX_9Njc/export?format=csv";
const REFRESH_MS=60000;

const listaImages = {
  "Lista B. Verdes Regionalistas y Humanistas": "https://upload.wikimedia.org/wikipedia/commons/5/59/Logo_PVH.png",
  "Lista C. Unidad por Chile": "https://upload.wikimedia.org/wikipedia/commons/a/a3/Unidad_por_Chile.png",
  "Lista I. Partido de la Gente": "https://upload.wikimedia.org/wikipedia/commons/7/76/Logo_PDG.png",
  "Lista J. Chile Grande y Unido": "https://upload.wikimedia.org/wikipedia/commons/6/6a/Logo_UDI.png",
  "Lista K. Cambio por Chile": "https://upload.wikimedia.org/wikipedia/commons/f/f8/Logo_RN.png"
};

function cleanListName(name){
  return String(name||"")
    .replace(/\n/g," ")
    .replace(/^["“”']+|["“”']+$/g,"")
    .trim();
}

function parseCSV(text){
  const clean=text.replace(/\r/g,"").replace(/\n{2,}/g,"\n");
  const lines=clean.trim().split("\n");
  const headers=lines.shift().split(",").map(h=>h.trim().toLowerCase());
  return lines.map(line=>{
    const cols=line.split(",");
    const obj={};
    headers.forEach((h,i)=>obj[h]=cols[i]?.trim()||"");
    return obj;
  });
}

async function fetchCSV(url){
  const r=await fetch(url+"?t="+Date.now(),{cache:"no-store"});
  return await r.text();
}

function renderListHeader(name){
  const listName = cleanListName(name);
  const logo = listaImages[listName] || "https://upload.wikimedia.org/wikipedia/commons/9/9a/Gray_circle.png";
  return `
    <div class="row list-header" style="display:flex;align-items:center;gap:10px;">
      <img src="${logo}" alt="${listName}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;border:1px solid #ccc;">
      <div style="font-weight:700;font-size:15px;color:#111;">${listName}</div>
    </div>
  `;
}

async function load(){
  const csv=await fetchCSV(DATA_URL);
  const rows=parseCSV(csv);
  const container=document.getElementById("rows");
  container.innerHTML="";
  rows.forEach(r=>{
    const name=r.candidate||r.nombre||"";
    if(name.toLowerCase().includes("lista")){
      container.innerHTML+=renderListHeader(name);
    } else {
      // mostrar candidatos (simplificado)
      container.innerHTML+=`
        <div class="row" style="display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-top:1px solid #eee;">
          <div style="font-weight:500;">${r.candidate}</div>
          <div style="color:#555;">${r.votes||"—"}</div>
        </div>`;
    }
  });
}

load();
setInterval(load, REFRESH_MS);
</script>

